#!/usr/bin/env bash

## Author : Customized by Honey
## Rofi WiZ Light Menu — Simplified for i3 + Flat Style Theme

# Constants
theme="$HOME/.config/rofi/themes/tokyonight-powermenu.rasi"
TOKEN=$(cat ~/.config/.ha_token)
ENTITY="light.wiz_rgbw_tunable_d1a2fa"
HA_URL="http://localhost:8123"

# Icons
light_on='󰛨'    # bulb on
light_off='󰛩'   # bulb off
white_mode=''  # bright white
purple=''      # purple
cyan=''        # cyan/light blue
yes=''
no=''

# Rofi Launcher
rofi_cmd() {
  rofi -dmenu \
    -p "Smart Light" \
    -theme "$theme"
}

# Confirmation Prompt
confirm_cmd() {
  rofi -theme-str 'window {location: center; anchor: center; fullscreen: false; width: 350px;}' \
    -theme-str 'mainbox {children: [ "message", "listview" ];}' \
    -theme-str 'listview {columns: 2; lines: 1;}' \
    -theme-str 'element-text {horizontal-align: 0.5;}' \
    -theme-str 'textbox {horizontal-align: 0.5;}' \
    -dmenu \
    -p 'Confirmation' \
    -mesg 'Are you sure?' \
    -theme "$theme"
}

# Ask for confirmation
confirm_exit() {
  echo -e "$yes\n$no" | confirm_cmd
}

# Display Menu
run_rofi() {
  echo -e "$light_on\n$light_off\n$white_mode\n$purple\n$cyan" | rofi_cmd
}

# API Helper Functions
turn_on() {
  curl -s -X POST -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -d "{\"entity_id\": \"$ENTITY\"}" \
    $HA_URL/api/services/light/turn_on
}

turn_off() {
  curl -s -X POST -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -d "{\"entity_id\": \"$ENTITY\"}" \
    $HA_URL/api/services/light/turn_off
}

set_color_temp() {
  local mireds=$1
  curl -s -X POST -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -d "{\"entity_id\": \"$ENTITY\", \"color_temp\": $mireds}" \
    $HA_URL/api/services/light/turn_on
}

set_rgb() {
  local r=$1
  local g=$2
  local b=$3
  curl -s -X POST -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -d "{\"entity_id\": \"$ENTITY\", \"rgb_color\": [$r,$g,$b]}" \
    $HA_URL/api/services/light/turn_on
}

# Command Dispatcher
run_cmd() {
  case "$1" in
  --on)
    selected="$(confirm_exit)"
    [[ "$selected" == "$yes" ]] && turn_on
    ;;
  --off)
    selected="$(confirm_exit)"
    [[ "$selected" == "$yes" ]] && turn_off
    ;;
  --white)
    # 6500K ≈ 153 mireds? Actually 6500K ≈ 153 mireds
    set_color_temp 153
    ;;
  --purple)
    # #8000FF → RGB(128,0,255)
    set_rgb 128 0 255
    ;;
  --cyan)
    # #00BFFF → RGB(0,191,255)
    set_rgb 0 191 255
    ;;
  esac
}

# Main Logic
chosen="$(run_rofi)"
case "$chosen" in
$light_on) run_cmd --on ;;
$light_off) run_cmd --off ;;
$white_mode) run_cmd --white ;;
$purple) run_cmd --purple ;;
$cyan) run_cmd --cyan ;;
esac

